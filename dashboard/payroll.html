<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FNE Payroll Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    .filters, .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #f4f4f4; }
    .section { margin-bottom: 40px; }
  </style>
</head>
<body>
  <h1>ðŸ’µ FNE Payroll Report</h1>

  <div class="filters">
    <label>Start Date: <input type="date" id="startDate" /></label>
    <label>End Date: <input type="date" id="endDate" /></label>
    <label>Worker: <input type="text" id="worker" placeholder="Worker name" /></label>
    <label>Project: <input type="text" id="project" placeholder="Project name" /></label>
    <button onclick="loadReport()">Load</button>
    <button onclick="clearFilters()">Clear</button>
  </div>

  <div class="actions">
    <button onclick="markPaid()">ðŸ’° Mark Selected as Paid</button>
    <button onclick="exportCSV()">ðŸ“¤ Export CSV</button>
  </div>

  <div class="section">
    <h2>ðŸ“Š Summary by Day / Worker / Project</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Worker</th>
          <th>Phone (Last 5)</th>
          <th>Project</th>
          <th>Date</th>
          <th>Regular</th>
          <th>OT</th>
          <th>Rate</th>
          <th>Amount</th>
          <th>Paid</th>
          <th>Paid Date</th>
          <th>Exported</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="7"><strong>Total</strong></td>
          <td id="totalAmount"><strong>$0.00</strong></td>
          <td colspan="3"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="section">
    <h2>ðŸ“‹ Detail Clock Entries</h2>
    <table id="detailTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" /></th>
          <th>ID</th>
          <th>Worker</th>
          <th>Phone</th>
          <th>Project</th>
          <th>Action</th>
          <th>Date</th>
          <th>Time</th>
          <th>Regular</th>
          <th>OT</th>
          <th>Pay</th>
          <th>Note</th>
          <th>Paid</th>
          <th>Paid Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let reportData = { grouped: [], raw: [] };

    function clearFilters() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('worker').value = '';
      document.getElementById('project').value = '';
      loadReport();
    }

    async function loadReport() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const worker = document.getElementById('worker').value;
      const project = document.getElementById('project').value;

      const params = new URLSearchParams();
      if (start) params.append('start', start);
      if (end) params.append('end', end);
      if (worker) params.append('worker', worker);
      if (project) params.append('project', project);

      const res = await fetch(`/api/payroll?${params.toString()}`);
      reportData = await res.json();

      renderSummary(reportData.grouped);
      renderDetails(reportData.raw);
    }

    function renderSummary(data) {
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      let total = 0;

      for (const row of data) {
        total += row.amount;
        tbody.innerHTML += `
          <tr>
            <td>${row.worker_name}</td>
            <td>${row.phone_number?.slice(-5) || ''}</td>
            <td>${row.project_name}</td>
            <td>${row.date}</td>
            <td>${row.regular_time}</td>
            <td>${row.overtime}</td>
            <td>$${row.pay_rate.toFixed(2)}</td>
            <td>$${row.amount.toFixed(2)}</td>
            <td>${row.paid ? 'âœ…' : ''}</td>
            <td>${row.paid_date || ''}</td>
            <td>${row.exported ? 'âœ…' : ''}</td>
          </tr>
        `;
      }

      document.getElementById('totalAmount').innerHTML = `<strong>$${total.toFixed(2)}</strong>`;
    }

    function renderDetails(data) {
      const tbody = document.querySelector('#detailTable tbody');
      tbody.innerHTML = '';
      for (const row of data) {
        tbody.innerHTML += `
          <tr>
            <td><input type="checkbox" data-id="${row.id}" /></td>
            <td>${row.id}</td>
            <td>${row.worker_name}</td>
            <td>${row.phone_number?.slice(-5)}</td>
            <td>${row.project_name}</td>
            <td>${row.action}</td>
            <td>${row.date}</td>
            <td>${row.time}</td>
            <td>${row.regular_time || 0}</td>
            <td>${row.overtime || 0}</td>
            <td>$${row.pay_amount?.toFixed(2) || 0}</td>
            <td>${row.note || ''}</td>
            <td>${row.paid ? 'âœ…' : ''}</td>
            <td>${row.paid_date || ''}</td>
          </tr>
        `;
      }

      document.getElementById('selectAll').onclick = () => {
        document.querySelectorAll('#detailTable tbody input[type="checkbox"]').forEach(cb => {
          cb.checked = document.getElementById('selectAll').checked;
        });
      };
    }

    async function markPaid() {
      const selectedIds = Array.from(document.querySelectorAll('#detailTable tbody input[type="checkbox"]:checked'))
        .map(cb => parseInt(cb.dataset.id));

      if (selectedIds.length === 0) return alert('No entries selected');
      const paid_date = prompt('Enter paid date (YYYY-MM-DD)', new Date().toISOString().slice(0, 10));
      if (!paid_date) return;

      const res = await fetch('/api/payroll/mark-paid', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds, paid_date })
      });

      if (res.ok) {
        alert('Marked as paid!');
        loadReport();
      } else {
        alert('Error updating paid status');
      }
    }

    function exportCSV() {
      const rows = [['Worker', 'Phone', 'Project', 'Date', 'Regular', 'OT', 'Rate', 'Amount']];
      for (const row of reportData.grouped) {
        rows.push([
          row.worker_name,
          row.phone_number?.slice(-5),
          row.project_name,
          row.date,
          row.regular_time,
          row.overtime,
          row.pay_rate,
          row.amount.toFixed(2)
        ]);
      }

      const csv = rows.map(r => r.map(String).map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'payroll_report.csv';
      a.click();
    }

    loadReport();
  </script>
</body>
</html>
