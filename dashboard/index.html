
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Clock Entries (Raw View)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    input[type="text"], input[type="datetime-local"] {
      width: 100%;
      box-sizing: border-box;
    }
    .filters { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filters label { display: flex; flex-direction: column; }
    .actions { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üóÉÔ∏è Raw Clock Entries</h1>

  <div class="filters">
    <label>
      From:
      <input type="date" id="filterStart">
    </label>
    <label>
      To:
      <input type="date" id="filterEnd">
    </label>
    <label>
      Worker:
      <input type="text" id="filterWorker" placeholder="Worker Name">
    </label>
    <label>
      Project:
      <input type="text" id="filterProject" placeholder="Project Name">
    </label>
    <button onclick="applyFilters()">Apply Filters</button>
    <button onclick="resetFilters()">Clear</button>
  </div>

  <table id="entriesTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Phone</th>
        <th>Worker</th>
        <th>Project</th>
        <th>Action</th>
        <th>DateTime (PST)</th>
        <th>Save</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allEntries = [];

    async function fetchEntries() {
      const res = await fetch('/api/clock-entries');
      const data = await res.json();
      allEntries = data;
      renderTable(data);
    }

    function renderTable(entries) {
      const tbody = document.querySelector("#entriesTable tbody");
      tbody.innerHTML = "";
      entries.forEach(entry => {
        const row = document.createElement("tr");
        row.innerHTML = \`
          <td>\${entry.id}</td>
          <td><input type="text" value="\${entry.phone_number}" data-field="phone_number" data-id="\${entry.id}" /></td>
          <td><input type="text" value="\${entry.worker_name}" data-field="worker_name" data-id="\${entry.id}" /></td>
          <td><input type="text" value="\${entry.project_name}" data-field="project_name" data-id="\${entry.id}" /></td>
          <td><input type="text" value="\${entry.action}" data-field="action" data-id="\${entry.id}" /></td>
          <td><input type="datetime-local" value="\${formatForInput(entry.datetime_pst)}" data-field="datetime_pst" data-id="\${entry.id}" /></td>
          <td><button onclick="saveEntry(\${entry.id})">üíæ</button></td>
        \`;
        tbody.appendChild(row);
      });
    }

    function formatForInput(dt) {
      const date = new Date(dt);
      return date.toISOString().slice(0, 16);
    }

    function applyFilters() {
      const start = document.getElementById("filterStart").value;
      const end = document.getElementById("filterEnd").value;
      const worker = document.getElementById("filterWorker").value.toLowerCase();
      const project = document.getElementById("filterProject").value.toLowerCase();

      const filtered = allEntries.filter(entry => {
        const dt = new Date(entry.datetime_pst);
        const dateStr = dt.toISOString().slice(0, 10);
        return (!start || dateStr >= start) &&
               (!end || dateStr <= end) &&
               (!worker || entry.worker_name.toLowerCase().includes(worker)) &&
               (!project || entry.project_name.toLowerCase().includes(project));
      });

      renderTable(filtered);
    }

    function resetFilters() {
      document.getElementById("filterStart").value = "";
      document.getElementById("filterEnd").value = "";
      document.getElementById("filterWorker").value = "";
      document.getElementById("filterProject").value = "";
      renderTable(allEntries);
    }

    async function saveEntry(id) {
      const inputs = document.querySelectorAll('[data-id="' + id + '"]');
      const updated = {};
      inputs.forEach(input => {
        updated[input.dataset.field] = input.value;
      });

      const res = await fetch('/api/clock-entries/' + id, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });

      if (res.ok) {
        alert("‚úÖ Saved!");
        fetchEntries();
      } else {
        alert("‚ùå Failed to save.");
      }
    }

    fetchEntries();
  </script>
</body>
</html>
